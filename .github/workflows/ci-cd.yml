name: Deploy CI/CD Pipeline

on:
    push:
        branches:
            - dev/auto-deploy

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Create .env file
              run: # Create the .env file and populate it line by line
                  echo "APP_KEY=YjfB4cZWo5pCEJXhX6Hmq47WpHUodrjB" > .env
                  echo "PORT=8000" >> .env
                  echo "ALLOW_ORIGIN=http://localhost:3000" >> .env
                  echo "API_V1=/api/v1" >> .env
                  echo "GIN_MODE=release" >> .env
                  echo "DB_CONNECTION=postgres" >> .env
                  echo "DB_HOST=autorack.proxy.rlwy.net" >> .env
                  echo "DB_PORT=10765" >> .env
                  echo "DB_NAME=railway" >> .env
                  echo "DB_USERNAME=$postgres" >> .env
                  echo "DB_PASSWORD=rFlvGMQagzroWQBQMbTHFbRZorMXEYlp" >> .env
                  echo "DB_SSLMODE=disable" >> .env
                  echo "DB_TIMEZONE=Asia/Jakarta" >> .env
                  echo "TZ=Asia/Jakarta" >> .env

            - name: Login to Docker Hub for build
              run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            - name: Build Docker Image
              run: docker build -t rfjst4real/edulink-api .

            - name: Push Docker Image to Docker Hub
              run: docker push rfjst4real/edulink-api:latest
    deploy:
        needs: build
        runs-on: self-hosted
        steps:
            - name: Login to Docker Hub for deployment
              run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            - name: Pull docker image
              run: docker pull rfjst4real/edulink-api:latest

            - name: Delete old container
              run: docker rm -f edulink-api-container

            - name: Run docker container
              run: docker run -d -p 8000:8000 --name edulink-api-container rfjst4real/edulink-api:latest
